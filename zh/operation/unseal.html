<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Unseal 任务的支持 | 执剑人</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/assets/damocles-icon.png">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-C1545RTPE5"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-C1545RTPE5');</script>
    <meta name="description" content="执剑人，原Venus算力服务，是一个Filecoin存储算力解决方案">
    
    <link rel="preload" href="/assets/css/0.styles.e2ff4576.css" as="style"><link rel="preload" href="/assets/js/app.fc5527b4.js" as="script"><link rel="preload" href="/assets/js/2.2a8cf6e9.js" as="script"><link rel="preload" href="/assets/js/49.5cb7d543.js" as="script"><link rel="prefetch" href="/assets/js/10.41cee622.js"><link rel="prefetch" href="/assets/js/11.063d7fa2.js"><link rel="prefetch" href="/assets/js/12.b03ec269.js"><link rel="prefetch" href="/assets/js/13.9d2fb996.js"><link rel="prefetch" href="/assets/js/14.d1a07afe.js"><link rel="prefetch" href="/assets/js/15.d0fe8e34.js"><link rel="prefetch" href="/assets/js/16.0e1e653a.js"><link rel="prefetch" href="/assets/js/17.e9fc107c.js"><link rel="prefetch" href="/assets/js/18.c4ee580e.js"><link rel="prefetch" href="/assets/js/19.3c9ac894.js"><link rel="prefetch" href="/assets/js/20.4aa98bf1.js"><link rel="prefetch" href="/assets/js/21.7eb6c26e.js"><link rel="prefetch" href="/assets/js/22.105ca1be.js"><link rel="prefetch" href="/assets/js/23.7d8c877e.js"><link rel="prefetch" href="/assets/js/24.5f3445b2.js"><link rel="prefetch" href="/assets/js/25.8b57f313.js"><link rel="prefetch" href="/assets/js/26.dfaefc95.js"><link rel="prefetch" href="/assets/js/27.08f6f991.js"><link rel="prefetch" href="/assets/js/28.1ef6e7dc.js"><link rel="prefetch" href="/assets/js/29.af3a25d1.js"><link rel="prefetch" href="/assets/js/3.33381665.js"><link rel="prefetch" href="/assets/js/30.d7b7cf45.js"><link rel="prefetch" href="/assets/js/31.b3e37c51.js"><link rel="prefetch" href="/assets/js/32.939eaaba.js"><link rel="prefetch" href="/assets/js/33.d6ec11b9.js"><link rel="prefetch" href="/assets/js/34.89e217d4.js"><link rel="prefetch" href="/assets/js/35.b85b8992.js"><link rel="prefetch" href="/assets/js/36.943f60b3.js"><link rel="prefetch" href="/assets/js/37.33d6e610.js"><link rel="prefetch" href="/assets/js/38.365de507.js"><link rel="prefetch" href="/assets/js/39.6273b0f4.js"><link rel="prefetch" href="/assets/js/4.d4393beb.js"><link rel="prefetch" href="/assets/js/40.020fbc1c.js"><link rel="prefetch" href="/assets/js/41.dec4e906.js"><link rel="prefetch" href="/assets/js/42.00b39768.js"><link rel="prefetch" href="/assets/js/43.9e091b21.js"><link rel="prefetch" href="/assets/js/44.efe1bfcd.js"><link rel="prefetch" href="/assets/js/45.25c67ba2.js"><link rel="prefetch" href="/assets/js/46.bad028e9.js"><link rel="prefetch" href="/assets/js/47.13452b98.js"><link rel="prefetch" href="/assets/js/48.310f5331.js"><link rel="prefetch" href="/assets/js/5.7af5716c.js"><link rel="prefetch" href="/assets/js/50.134d2756.js"><link rel="prefetch" href="/assets/js/6.354469f3.js"><link rel="prefetch" href="/assets/js/7.d4b63fde.js"><link rel="prefetch" href="/assets/js/8.9e6dae2f.js"><link rel="prefetch" href="/assets/js/9.bb4a042f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2ff4576.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/assets/damocles-icon.png" alt="执剑人" class="logo"> <span class="site-name can-hide">执剑人</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/intro/" class="nav-link">
  功能介绍
</a></div><div class="nav-item"><a href="/zh/operation/" class="nav-link router-link-active">
  部署/运维
</a></div><div class="nav-item"><a href="/zh/developer/" class="nav-link">
  研发/设计
</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/unseal.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/intro/" class="nav-link">
  功能介绍
</a></div><div class="nav-item"><a href="/zh/operation/" class="nav-link router-link-active">
  部署/运维
</a></div><div class="nav-item"><a href="/zh/developer/" class="nav-link">
  研发/设计
</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/unseal.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>部署</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/operation/quick-start.html" class="sidebar-link">快速上手</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>配置</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/operation/damocles-manager-config.html" class="sidebar-link">damocles-manager 配置</a></li><li><a href="/zh/operation/damocles-worker-config.html" class="sidebar-link">damocles-worker 配置</a></li><li><a href="/zh/operation/processors-config-example.html" class="sidebar-link">外部执行器配置范例</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>运维</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/operation/task-management.html" class="sidebar-link">worker 任务管理</a></li><li><a href="/zh/operation/task-flow.html" class="sidebar-link">任务状态流转</a></li><li><a href="/zh/operation/poster.html" class="sidebar-link">独立 Poster</a></li><li><a href="/zh/operation/snapup.html" class="sidebar-link">snapdeal 支持</a></li><li><a href="/zh/operation/worker-util.html" class="sidebar-link">damocles-worker-util</a></li><li><a href="/zh/operation/custom-algo.html" class="sidebar-link">自定义算法/存储方案</a></li><li><a href="/zh/operation/metrics.html" class="sidebar-link">damocles-manager metrics 使用</a></li><li><a href="/zh/operation/hugeTLB.html" class="sidebar-link">PC1 hugeTLB 支持</a></li><li><a href="/zh/operation/sector-rebuild.html" class="sidebar-link">扇区重建支持</a></li><li><a href="/zh/operation/unseal.html" aria-current="page" class="active sidebar-link">unseal 反封装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/operation/unseal.html#unseal-任务的支持" class="sidebar-link">Unseal 任务的支持</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>迁移</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/operation/migrate-sectors.html" class="sidebar-link">导入已有扇区</a></li><li><a href="/zh/operation/migrate-miner.html" class="sidebar-link">lotus-miner 与 damocles 切换流程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>FAQ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/operation/faq.html" class="sidebar-link">常见问题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="unseal-任务的支持"><a href="#unseal-任务的支持" class="header-anchor">#</a> Unseal 任务的支持</h2> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <p>订单检索是 Filecoin 生态闭环中的一个重要环节，当前 <code>Droplet</code> 会默认使用其 <code>PieceStore</code> 中的 <code>Piece 数据</code>响应检索订单的数据请求。同时用户也可以通过配置来控制 <code>Droplet</code> 缓存的 Piece 数据，当 Droplet 发现数据库中 没有该目标 Piece 的数据时，就会触发 <code>unseal 任务</code>，并向 <code>Damocles</code> 下发该任务。
<code>Damocles Manager</code> （下称：<code>Manager</code> ）在接收到该任务之后，会将其分配给支持 <code>unseal plan</code>  的 <code>Damocles Worker</code> （下称：<code>Worker</code>）。待  <code>Worker</code> 完成该任务之后，就会将 unseal 之后的文件上传到 <code>unseal 任务</code>中指定的位置（该位置，默认是 <code>Droplet</code> 的 PieceStore） 。</p> <h3 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h3> <p>订单在在封装完成之后会将 <code>sealed file</code> 留存在<code>永久存储目录</code>，用以应对时空证明和 <code>unseal 任务</code>。
<code>Woker</code> 在接收到 <code>unseal 任务</code>之后，会从  <code>Manager</code> 获取目标 Piece 数据 所在扇区的<code>sealed file</code>  和 <code>元数据</code>，然后执行 PC1 的逆向算法，还原 Piece 数据。</p> <h3 id="启用"><a href="#启用" class="header-anchor">#</a> 启用</h3> <p><code>Damocles</code> 支持 <code>unseal 任务</code> 只需要  <code>Worker</code> 启用一个支持 <code>unseal plan</code> 的<code>封装进程</code>即可。
启用 <code>unseal plan</code>的<code>封装进程</code>可以有两种方式：</p> <ol><li>直接修改 <code>Woker</code> 的主配置文件，新增一个 封装进程，或者直接修改 现有封装进程的 <code>plan</code> 等待适当的时机重启。</li></ol> <div class="language-TOML extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">sealing_thread</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token key property">location</span> <span class="token punctuation">=</span> <span class="token string">&quot;./mock-tmp/store1&quot;</span>
<span class="token key property">plan</span> <span class="token punctuation">=</span> <span class="token string">&quot;unseal&quot;</span>
</code></pre></div><ol><li>使用<code>配置热更新</code>的方式，添加或修改封装进程。详细参见 配置热更新章节</li></ol> <h3 id="手动触发-unseal-任务"><a href="#手动触发-unseal-任务" class="header-anchor">#</a> 手动触发 unseal 任务</h3> <p>在 Piece 数据 意识或者某一些别的特殊情形下，我们可能会希望能够手动触发 <code>unseal 任务</code>，获取 Piece 数据。
这时我们就可以通过  <code>Manager</code> 提供的命令行工具来手动生成并触发 <code>unseal 任务</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code>damocles-manager util sealer sectors unseal
NAME:
   damocles-manager util sealer sectors unseal - unseal specified sector

USAGE:
   damocles-manager util sealer sectors unseal <span class="token builtin class-name">command</span> <span class="token punctuation">[</span>command options<span class="token punctuation">]</span> <span class="token operator">&lt;</span>piece_cid<span class="token operator">&gt;</span>

COMMANDS:
   help, h  Shows a list of commands or <span class="token builtin class-name">help</span> <span class="token keyword">for</span> one <span class="token builtin class-name">command</span>

OPTIONS:
   --output value, -o value                        output piece as a car <span class="token function">file</span> to the specific path
   --actor value, --miner value, --actor-id value  specify actor <span class="token function">id</span> of miner manully, it must worke with flag <span class="token string">&quot;--sector&quot;</span>  <span class="token punctuation">(</span>default: <span class="token number">0</span><span class="token punctuation">)</span>
   --sector value, --sector-id value               specify sector number manully, it must worke with flag <span class="token string">&quot;--actor&quot;</span>  <span class="token punctuation">(</span>default: <span class="token number">0</span><span class="token punctuation">)</span>
   --piece-info-from-droplet, --from-droplet       get piece info from droplet, <span class="token function">which</span> come from damocles db by default <span class="token builtin class-name">.</span> <span class="token punctuation">(</span>default: <span class="token boolean">false</span><span class="token punctuation">)</span>
   --unseal-file value                             unseal piece from unseal <span class="token function">file</span>
   --offset value                                  specify offset of piece manually <span class="token punctuation">(</span>default: <span class="token number">0</span><span class="token punctuation">)</span>
   --size value                                    specify size of piece manually <span class="token punctuation">(</span>default: <span class="token number">0</span><span class="token punctuation">)</span>
   --dest value                                    specify destination to transfer piece manually, there are five protocols can be used:<span class="token string">&quot;file:///path&quot;</span>,<span class="token string">&quot;http://&quot;</span> <span class="token string">&quot;https://&quot;</span>, <span class="token string">&quot;market://store_name/piece_cid&quot;</span>, <span class="token string">&quot;store://store_name/piece_cid&quot;</span>
   --help, -h                                      show <span class="token builtin class-name">help</span> <span class="token punctuation">(</span>default: <span class="token boolean">false</span><span class="token punctuation">)</span>

</code></pre></div><h4 id="unseal-piece-简单使用"><a href="#unseal-piece-简单使用" class="header-anchor">#</a> unseal piece 简单使用</h4> <p>用户可以直接通过 piece 数据的 cid (piececid) 来发布一个 <code>unseal 任务</code>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>damocles-manager util sealer sectors unseal <span class="token operator">&lt;</span>piece_cid<span class="token operator">&gt;</span>
</code></pre></div><p>此时  <code>Manager</code> 会生成一个 <code>unseal 任务</code>。
此时  <code>Manager</code> 中能看到 unseal 任务相关的日志，形如：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">add</span> new dest to unseal task
</code></pre></div><p>此时，程序会持续运行，直到 unseal 任务完成，会在当前目录生成一个 名字为 piece cid 的文件。</p> <h4 id="flag-解释"><a href="#flag-解释" class="header-anchor">#</a> flag 解释</h4> <h5 id="指定不同方式获取-piece-info"><a href="#指定不同方式获取-piece-info" class="header-anchor">#</a> 指定不同方式获取 piece info</h5> <p>还原 piece 数据需要获取 piece 数据在扇区中的位置和大小，<code>unseal 任务</code> 默认会从 <code>Manager</code> 数据库中获取 piece 数据的 <code>offset</code> 和 <code>size</code> 信息，但是有时候，数据库中的数据丢失或者不完整的时候，我们可能希望可以从别的地方获取这些参数或者可以手动指定这两个参数，这时候就可以用到以下三个 flag：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>   --from-droplet             get piece info from venus-market, <span class="token function">which</span> come from damocles db by default <span class="token builtin class-name">.</span> <span class="token punctuation">(</span>default: <span class="token boolean">false</span><span class="token punctuation">)</span>
   --offset value            specify offset of piece manually <span class="token punctuation">(</span>default: <span class="token number">0</span><span class="token punctuation">)</span>
   --size value              specify size of piece manually <span class="token punctuation">(</span>default: <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>from-droplet 从 <code>Droplet</code> 获取 <code>offset</code> 和 <code>size</code>，前提是 <code>Manager</code> 已经连接了 <code>Droplet</code>。</li> <li>offset：piece 数据在 扇区中的 位置</li> <li>size：Piece 数据的大小</li></ul> <p>如果你才升级到 v0.7.0 之后的版本没多久，可能会存在数据库中数据不完整的情况（v0.7.0 之前，数据库不会记录 <code>offset</code> ）。</p> <h5 id="指定-piece-数据输出的位置"><a href="#指定-piece-数据输出的位置" class="header-anchor">#</a> 指定 piece 数据输出的位置</h5> <p>有时候我们可能希望指定 piece 数据输出的位置，可以使用  <code>-o</code> flag 指定输出位置</p> <div class="language-sh extra-class"><pre class="language-sh"><code>   --output value, -o value  output piece as a car <span class="token function">file</span> to the specific path
</code></pre></div><h5 id="直接从-unseal-文件还原-piece-数据"><a href="#直接从-unseal-文件还原-piece-数据" class="header-anchor">#</a> 直接从 unseal 文件还原 piece 数据</h5> <p><code>Damocles</code> 默认从 <code>sealed 文件</code> 还原 piece 数据，但是如果用户留存了 <code>unseal 文件</code>, 可以直接从 <code>unseal 文件</code> 还原 piece 数据，这会节省大量的时间和资源，这时候可以使用 <code>--unseal-file</code> flag 指定 piece 对应的 <code>unseal 文件</code> 的路径。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>   --unseal-file value  unseal piece from unseal <span class="token function">file</span>
</code></pre></div><h5 id="通过-dest-协议将文件上传值目标位置"><a href="#通过-dest-协议将文件上传值目标位置" class="header-anchor">#</a> 通过 dest 协议将文件上传值目标位置</h5> <p>默认情况下，以及加了<code>-o</code>flag 的情况下，<code>Worker</code>  unseal 得到的 piece 数据会上传到  <code>Manager</code> ，由  <code>Manager</code> 将其输出到  <code>Manager</code> 所在机器的指定路径上。
但有时候，我们并不希望 <code>Worker上传</code> piece 数据到 <code>Manager</code> ，而是直接上传到别的目标位置，这个时候就需要用到  <code>--dest</code>flag。</p> <p>dest 协议支持通过以下四种方式指定上传 piece 数据的目标位置：</p> <ul><li>将文件直接输出到 <code>Worker</code> 本地
<ul><li>&quot;file:///path&quot;</li> <li>注意，上述 url 中 host 的位置必须为空。</li></ul></li> <li>网络位置
<ul><li>&quot;http://&quot; &quot;https://&quot;</li></ul></li> <li>上传至 <code>Droplet</code> 的 <code>piece store</code> <ul><li>&quot;market://store_name/piece_cid&quot;</li> <li>其中 <code>store_name</code> 指的是 market 中 piece store 的名字</li></ul></li> <li>上传至  <code>Manager</code> 的<code>piece store</code> <ul><li>&quot;store://store_name/piece_cid&quot;</li> <li>其中 <code>store_name</code> 指的是 <code>Manager</code> 中 <code>piece store</code> 的名字</li> <li>注意：应确保  <code>Manager</code> 的 <code>piece store</code>已经挂载并配置到 <code>Worker</code> 中</li></ul></li></ul> <p>因为从 <code>unseal 文件</code> 还原 piece 数据是不需要经过 <code>Worker</code> 的，所以这个时候指定 <code>--dest</code> flag 是无效的</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ipfs-force-community/damocles-docs/edit/main/docs/zh/operation/unseal.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/operation/sector-rebuild.html" class="prev">
        扇区重建支持
      </a></span> <span class="next"><a href="/zh/operation/migrate-sectors.html">
        导入已有扇区
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fc5527b4.js" defer></script><script src="/assets/js/2.2a8cf6e9.js" defer></script><script src="/assets/js/49.5cb7d543.js" defer></script>
  </body>
</html>
